<?php 

//------------------------RESTFULL---------------------------
require '../function/functions.php';
require '../api/api_malware.php';
require '../api/api_recent.php';

$idm = $_GET['idm'];
$id = $_GET['id'];

if (isset($id)){
	$mal = getMalwareById($id);
	$filename = $mal['file_malware'];

	
	
	//unduh file
	$file = ("../../../rest-server/directory/file_malware/$filename");
	if(file_exists($file)){
		header('Content-Description: File Transfer');
		header('Content-Type: application/octet-stream');
		header('Content-Disposition: attachment; filename='.basename($file));
		header('Expires:0');
		header('Cache-Control: private');
		header('Pragma: private');
		header('Content-Length:'.filesize($file));
		ob_clean();
		flush();
		readfile($file);

		//input ke recent
		$dataRec = [
			'idm' => $idm,
			'file_mitra' => $mal["file_malware"],
			'sha256_mitra' => $mal["sha256_malware"],
			'status' => "Malware",
			'aksi' => "Unduh",
			'metode' => "-"
		];

		if( createMRiwayat($dataRec) === 0){
			echo "<script>
				alert('Data Gagal ditambahkan ke recent!');
				document.location.href = m.lab.php?idm=<?=$idm;?>;
				</script>";
		}
	
		exit;
	}
	echo "<script>
              alert('File tidak ada dalam directory!');
              document.location.href = 'malware.php';
              </script>";
}
?>