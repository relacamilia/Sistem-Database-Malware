<?php 
session_start();
if( !isset($_SESSION["m.login"])){
  header("Location: m.login.php");
  exit;
}

//------------------------------RESTFULL------------------------------
require '../function/functions.php';
require '../function/functions_deteksi.php';
require '../api/api_mitra.php';
require '../api/api_baru.php';
require '../api/api_recent.php';

$idm = $_GET['idm'];
$file_baru = $_GET["file"];
$tipe_file_baru = $_GET["tipe"];
$ukuran_file_baru = $_GET["ukuran"];
$sha256_baru = $_GET["sha256"];

$row = getMitraById($idm);

//cek apakah tombol submit sudah ditekan atau belum:
if (isset($_POST["submit"])) {

  $data = [
    'file_baru' => $file_baru,
    'ukuran_file_baru' => $ukuran_file_baru,
    'sha256_baru' => $sha256_baru,
    'pengirim' => "Mitra",
    'email' => $row["email"]
  ];

  if( createBaru($data) === 0){
    echo "<script>
            alert('File GAGAL Diupload!');
            document.location.href = 'm.deteksi.php?idm=$idm';
            </script>";
    
  } else {
    echo "<script>
            alert('File BERHASIL Diupload!');
            document.location.href = 'm.deteksi_tiket.php?idm=$idm &sha256=$sha256_baru';
            </script>";

  } 
}

?>

<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../fontawesome-web/css/all.min.css">
    <title>Sistem Database Malware</title>
  </head>

  <body class="mt-3">
    <!-- navbar -->
    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-info">
      <div class="container">
      <div class="navbar-brand text-light">
      <img src="../../img/1.png" width="30" height="30"> Sistem Database Malware</div>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav font-weight-bold">
        <div class="row text-center ml-5">
          <a class="nav-item nav-link ml-5" href="m.akun.php?idm=<?=$idm;?>">PROFIL</a>
          <a class="nav-item nav-link" href="m.index.php?idm=<?=$idm;?>">MENU</a>
          <a class="nav-item nav-link active" href="m.deteksi.php?idm=<?=$idm;?>">DETEKSI<span class="sr-only">(current)</span></a>
          <a class="nav-item nav-link" href="m.lab.php?idm=<?=$idm;?>">LAB</a>
          <a class="nav-item nav-link" href="m.riwayat.php?idm=<?=$idm;?>">RIWAYAT</a>
        </div>
        </div>
        <div class="navbar-nav ml-auto">
          <a class="nav-item nav-link btn btn-sm btn-outline-dark font-weight-bold" data-toggle="modal" data-target="#logoutModal"><i class="fas fa-sign-out-alt pr-1"></i>Logout</a>
        </div>
      </div>
      </div>
    </nav>
    <!-- akhir navbar -->

    <!-- DETEKSI-perlu analisa -->
    <section class="deteksi_perlu_analisa" id="deteksi_perlu_analisa">
    <div class="container">
      <div class="row">
        <div class="col-sm-12 text-center text-dark">
          <hr class="border-secondary">
          <h2 class="font-weight-bold pt-5">DETEKSI MALWARE</h2>
        </div>
      </div>
     
      <div class="row">
        <div class="col text-center">
          <h6 class="pt-3 pb-2 mr-1">Status File:</h6>
        </div>
      </div>

      <div class="card">
        <div class="card-body">   
          <div class="card-header alert-info">
            <h3 class="font-weight-bold text-center">PERLU ANALISA</h3>
          </div> 

          <div class="row">
            <div class="col-4 text-center">
              <img src="../../img/22.png" width="180" class="pt-4"> 
              <h6 class="font-weight-bold text-center text-info py-3">PERLU ANALISA LEBIH LANJUT</h6>  
            </div>

            <div class="col-6 pb-3 text-center">
              <table class="table table-sm table-borderless text-info">
                <tbody><br><br>
                  <tr>
                    <td>Sistem Database Kami belum memiliki data tentang file yang Anda scan. Kami akan melakukan analisa lebih lanjut terhadap file ini. Hasil analisa akan Kami kirim melalui email Anda:</td>
                  </tr>
                  <tr>
                    <td>
                    <h5 class="text-center text-info"><?=$row["email"];?></h5>
                    </td>
                  </tr>
                  <tr>
                    <td>Terimakasih.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <h5 class="card-header font-weight-bold text-center alert-info">DATA FILE</h5>
              <table class="table table-sm mt-3">
                <tbody>
                <input type="hidden" name="id" value="<?= $baru["id_baru"]; ?>">
                  <tr>
                    <td>Signature (SHA256)</td>
                    <td>: <?= $sha256_baru ?></td>
                  </tr>
                  <tr>
                    <td>Nama File</td>
                    <td>: <?= $file_baru ?></td>
                  </tr>
                  <tr>
                    <td>Ukuran File</td>
                    <td>: <?= $ukuran_file_baru ?></td>
                  </tr>      
                  <tr>
                    <td>Tipe File</td>
                    <td>: <?= $tipe_file_baru ?></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="row justify-content-center pt-3">
        <form action="" method="post">
          <div class="col text-center mb-4">
            <button type="submit" id="submit" name="submit" class="btn btn-info">Kirim Sampel</button>
          </div>
        </form>
      </div>
    </div>
    </section><br>
    <!-- akhir DETEKSI-perlu analisa -->

    <!-- menu LOGOUT -->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="logoutModalLabel">LOGOUT</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Apakah anda yakin akan keluar dari akun Mitra Anda?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
            <a href="m.logout.php"><button type="button" class="btn btn-info">Keluar</button></a>
          </div>
        </div>
      </div>
    </div>
    <!-- akhir menu LOGOUT --> 

    <!-- footer -->
    <footer class="bg-info text-white">
      <div class="row pt-3">
        <div class="col text-center">
          <p>&copy; Copyright 2020 | by Rela Annisa Camilia.</p>
        </div>
      </div>
    </footer>
    <!-- akhir footer -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script type="text/javascript" src="../../js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="../../js/popper.min.js"></script>
    <script type="text/javascript" src="../../js/bootstrap.min.js"></script>
  </body>
</html>