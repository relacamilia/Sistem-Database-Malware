<?php

require '../../guzzle/vendor/autoload.php';
use GuzzleHttp\Client;

$client = new Client([
    'base_uri' => 'http://localhost/tesisrela/rest-server/api/'
]);
 

//------------------------------- GET ALL | MENAMPILKAN --------------------------------
function getAllMitra(){

    global $client;    
    $response = $client->request('GET', "mitra", []);
    $result = json_decode($response->getBody()->getContents(),true);
    return $result['data'];

}


//-------------------------------- GET BY ID | DETAIL ----------------------------------
function getMitraById($idm){

    global $client;
    $response = $client->request('GET', "mitra", [
        'query' => ['id_mitra' => $idm]
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result['data'][0];

}


//----------------------------- GET BY USERNAME | LOGIN---------------------------------
function getMitraByUsername($username){

    global $client;
    $response = $client->request('GET', "mitra", [
        'query' => ['username' => $username]
    ]);
    
    $result = json_decode($response->getBody()->getContents(),true);

    if (($result["status"]) === 0 ) {
        return 0;
    } else {
        return $result["data"][0];
    } 
}


//--------------------------------- DELETE | HAPUS -----------------------------------
function deleteMitra($id){

    global $client;
    $response = $client->request('DELETE', "mitra", [
        'form_params' => ['id_mitra' => $id]
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result;

}


//---------------------------------- CREATE | TAMBAH ---------------------------------
function createMitra($dataMal){

    global $client;
    $password= htmlspecialchars($dataMal["password"]);
	$password = password_hash($password, PASSWORD_DEFAULT);

    $data = [
        
        'nama' => htmlspecialchars($dataMal["nama"]),
        'username' => strtolower(stripslashes($dataMal["username"])),
        'password' => $password,
        'email' => htmlspecialchars($dataMal["email"]),
        'instansi' => htmlspecialchars($dataMal["instansi"]),
        'foto' => "default.png"

    ];

    $response = $client->request('POST', 'mitra', [
        'form_params' => $data
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result['status'];
}


//---------------------------------- UPDATE | EDIT ---------------------------------
//update foto baru
function updateMitraFoto($dataMit)
{   
    global $client;
    $contents = $_FILES['foto']['tmp_name'];
    $namaFoto = $_FILES['foto']['name'];

    $data = [

        'id_mitra' => $dataMit["id_mitra"],  
        'nama' => htmlspecialchars($dataMit["nama"]),
        'username' => htmlspecialchars($dataMit["username"]),
        'password' => $dataMit["password"],
        'email' => htmlspecialchars($dataMit["email"]),
        'instansi' => htmlspecialchars($dataMit["instansi"]),
        'foto' => htmlspecialchars($namaFoto),
        'contents' => $contents 
         
    ];

    $response = $client->request('PUT', 'mitra',[    
       'form_params' => $data                  
    ]);

    $result = json_decode($response->getBody()->getContents(), true);
    return $result['status'];
    
}


//update tanpa foto
function updateMitra($dataMit)
{   
    global $client;

    $data = [

        'id_mitra' => $dataMit["id_mitra"],  
        'nama' => htmlspecialchars($dataMit["nama"]),
        'username' => htmlspecialchars($dataMit["username"]),
        'password' => $dataMit["password"],
        'email' => htmlspecialchars($dataMit["email"]),
        'instansi' => htmlspecialchars($dataMit["instansi"]),
        'foto' =>  $dataMit["foto_lama"]
         
    ];

    $response = $client->request('PUT', 'mitra',[    
       'form_params' => $data                  
    ]);

    $result = json_decode($response->getBody()->getContents(), true);
    return $result['status'];
    
}


//update pass
function updateMitraPass($dataMit)
{   
    global $client;
    $pass_baru = htmlspecialchars($dataMit["password"]);
    $password = password_hash($pass_baru, PASSWORD_DEFAULT);

    $data = [

        'id_mitra' => $dataMit["idm"],  
        'nama' => htmlspecialchars($dataMit["nama"]),
        'username' => htmlspecialchars($dataMit["username"]),
        'password' => $password,
        'email' => htmlspecialchars($dataMit["email"]),
        'instansi' => htmlspecialchars($dataMit["instansi"]),
        'foto' =>  htmlspecialchars($dataMit["foto"])
         
    ];

    $response = $client->request('PUT', 'mitra',[    
       'form_params' => $data                  
    ]);

    $result = json_decode($response->getBody()->getContents(), true);
    return $result['status'];
    
}


?>