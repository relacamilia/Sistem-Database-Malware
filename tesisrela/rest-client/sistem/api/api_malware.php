<?php

require '../../guzzle/vendor/autoload.php';
use GuzzleHttp\Client;

$client = new Client([
    'base_uri' => 'http://localhost/tesisrela/rest-server/api/'
]);


//--------------------------GET ALL | TAMPILKAN -------------------------
function getAllMalware(){

    global $client;    
    $response = $client->request('GET', "malware", []);
    $result = json_decode($response->getBody()->getContents(),true);
    return $result['data'];

}


//-------------------------- GET BY ID | DETAIL --------------------------
function getMalwareById($id){

    global $client;
    $response = $client->request('GET', "malware", [
        'query' => ['id_malware' => $id]
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result['data'][0];

}


//-------------------------- GET BY HASH | DETAIL --------------------------
function getMalwareByHash($sha256_user){

    global $client;
    $response = $client->request('GET', "malware", [
        'query' => ['sha256' => $sha256_user]
    ]);

    $result = json_decode($response->getBody()->getContents(),true);

    if (($result["status"]) === 0 ) {
        return 0;
    } else {
        return $result['data'][0];
    }
}


//----------------------------- DELETE | HAPUS ---------------------------
function deleteMalware($id){

    global $client;
    $response = $client->request('DELETE', "malware", [
        'form_params' => ['id_malware' => $id]
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result;

}


//-------------------------- CREATE | TAMBAH -----------------------------
function createMalware($dataMal){

    global $client;
    $contents = $_FILES['file_malware']['tmp_name'];
    $name = $_FILES['file_malware']['name'];

    $data = [

        'contents' => $contents,
        'waktu' => date("d-m-Y h:i:s"),
        'file_malware' => $name,
        'tipe_file_malware' => "zip",
        'ukuran_file_malware' => formatBytes($_FILES['file_malware']['size']),
        'md5_malware' => hash_file('md5', $contents),
        'sha1_malware' => hash_file('sha1', $contents),
        'sha256_malware' => hash_file('sha256', $contents),
        
        'ssdeep' => htmlspecialchars($dataMal["ssdeep"]),
        'vhash' => htmlspecialchars($dataMal["vhash"]),
        'nama' => htmlspecialchars($dataMal["nama"]),
        'nama_lain' => htmlspecialchars($dataMal["nama_lain"]),
        'jenis' => htmlspecialchars($dataMal["jenis"]),
        'karakteristik' => htmlspecialchars($dataMal["karakteristik"]),
        'cara_kerja' => htmlspecialchars($dataMal["cara_kerja"]),
        'penyebaran' => htmlspecialchars($dataMal["penyebaran"]),
        'bahaya' => htmlspecialchars($dataMal["bahaya"]),
        'target' => htmlspecialchars($dataMal["target"]),
        'ket' => htmlspecialchars($dataMal["ket"]),       
        'pencegahan' => htmlspecialchars($dataMal["pencegahan"]),       
        'penanganan' => htmlspecialchars($dataMal["penanganan"]),       
        'pemulihan' => htmlspecialchars($dataMal["pemulihan"]),       
        'pembuat_file' => htmlspecialchars($dataMal["pembuat_file"]),      
        'note' => htmlspecialchars($dataMal["note"]),        
        'kontak' => htmlspecialchars($dataMal["kontak"]),        
        'enkripsi' => htmlspecialchars($dataMal["enkripsi"]),        
        'tebusan' => htmlspecialchars($dataMal["tebusan"])    

    ];


    $response = $client->request('POST', 'malware', [
        'form_params' => $data
    ]);

    $result = json_decode($response->getBody()->getContents(),true);
    return $result["status"];

}


//---------------------------------- UPDATE | EDIT ---------------------------------
function updateMalware($dataMal)
{   
    global $client;

    $data = [

        'id_malware' => $dataMal["id_malware"],  
        'waktu' => $dataMal["waktu"],
        'file_malware' => $dataMal["file_malware"],
        'tipe_file_malware' => $dataMal["tipe_file_malware"],
        'ukuran_file_malware' => $dataMal["ukuran_file_malware"],
        'md5_malware' => $dataMal["md5_malware"],
        'sha1_malware' => $dataMal["sha1_malware"],
        'sha256_malware' => $dataMal["sha256_malware"],

        'ssdeep' => htmlspecialchars($dataMal["ssdeep"]),
        'vhash' => htmlspecialchars($dataMal["vhash"]),
        'nama' => htmlspecialchars($dataMal["nama"]),
        'nama_lain' => htmlspecialchars($dataMal["nama_lain"]),
        'jenis' => htmlspecialchars($dataMal["jenis"]),
        'karakteristik' => htmlspecialchars($dataMal["karakteristik"]),
        'cara_kerja' => htmlspecialchars($dataMal["cara_kerja"]),
        'penyebaran' => htmlspecialchars($dataMal["penyebaran"]),
        'bahaya' => htmlspecialchars($dataMal["bahaya"]),
        'target' => htmlspecialchars($dataMal["target"]),
        'ket' => htmlspecialchars($dataMal["ket"]),       
        'pencegahan' => htmlspecialchars($dataMal["pencegahan"]),       
        'penanganan' => htmlspecialchars($dataMal["penanganan"]),       
        'pemulihan' => htmlspecialchars($dataMal["pemulihan"]),       
        'pembuat_file' => htmlspecialchars($dataMal["pembuat_file"]),      
        'note' => htmlspecialchars($dataMal["note"]),        
        'kontak' => htmlspecialchars($dataMal["kontak"]),        
        'enkripsi' => htmlspecialchars($dataMal["enkripsi"]),        
        'tebusan' => htmlspecialchars($dataMal["tebusan"])   
         
    ];
    

    $response = $client->request('PUT', 'malware',[    
       'form_params' => $data                  
    ]);

    $result = json_decode($response->getBody()->getContents(), true);
    return $result;
    
}



//---------------------------------- UPDATE | EDIT ---------------------------------
function updateMalwareFile($dataMal)
{   
    global $client;
    $contents = $_FILES['file_malware_baru']['tmp_name'];
    $name = $_FILES['file_malware_baru']['name'];

    $data = [

        'id_malware' => $dataMal["id_malware"],  
        'waktu' => $dataMal["waktu"],
        'file_malware' => $name,
        'tipe_file_malware' => "zip",
        'ukuran_file_malware' => formatBytes($_FILES['file_malware_baru']['size']),
        'md5_malware' => hash_file('md5', $contents),
        'sha1_malware' => hash_file('sha1', $contents),
        'sha256_malware' => hash_file('sha256', $contents),

        'ssdeep' => htmlspecialchars($dataMal["ssdeep"]),
        'vhash' => htmlspecialchars($dataMal["vhash"]),
        'nama' => htmlspecialchars($dataMal["nama"]),
        'nama_lain' => htmlspecialchars($dataMal["nama_lain"]),
        'jenis' => htmlspecialchars($dataMal["jenis"]),
        'karakteristik' => htmlspecialchars($dataMal["karakteristik"]),
        'cara_kerja' => htmlspecialchars($dataMal["cara_kerja"]),
        'penyebaran' => htmlspecialchars($dataMal["penyebaran"]),
        'bahaya' => htmlspecialchars($dataMal["bahaya"]),
        'target' => htmlspecialchars($dataMal["target"]),
        'ket' => htmlspecialchars($dataMal["ket"]),       
        'pencegahan' => htmlspecialchars($dataMal["pencegahan"]),       
        'penanganan' => htmlspecialchars($dataMal["penanganan"]),       
        'pemulihan' => htmlspecialchars($dataMal["pemulihan"]),       
        'pembuat_file' => htmlspecialchars($dataMal["pembuat_file"]),      
        'note' => htmlspecialchars($dataMal["note"]),        
        'kontak' => htmlspecialchars($dataMal["kontak"]),        
        'enkripsi' => htmlspecialchars($dataMal["enkripsi"]),        
        'tebusan' => htmlspecialchars($dataMal["tebusan"]),
        'contents' => $contents
         
    ];

    $response = $client->request('PUT', 'malware',[    
       'form_params' => $data                  
    ]);

    $result = json_decode($response->getBody()->getContents(), true);
    return $result;
    
}


?>