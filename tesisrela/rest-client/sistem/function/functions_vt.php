<?php


//cek pakah ada report file di dataset virustotal, kalau ada tampilkan (vt v3)
function virusTotal($hash){

  $headers = array('x-apikey:e4f0c6fc1643f7fb301d1e19d3ab6720fcfd3a2e7a625d909e2082647920906b');
      $ch = curl_init();
      curl_setopt($ch, CURLOPT_URL, "https://www.virustotal.com/api/v3/files/$hash");
      curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
      curl_setopt($ch, CURLOPT_POST,1);
      curl_setopt($ch, CURLOPT_VERBOSE, 1); 
      curl_setopt($ch, CURLOPT_ENCODING, 'gzip,deflate');
      curl_setopt($ch, CURLOPT_USERAGENT, "gzip, My php curl client");
      curl_setopt($ch, CURLOPT_RETURNTRANSFER ,true);
      curl_setopt($ch, CURLOPT_HTTPGET, true);
      $result=curl_exec ($ch);
      $status_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

      //jika ada report di dataset vt
      if ($status_code == 200) { 
        $js = json_decode($result, true);       
        return $js;

      //error lainnya
      } else {  
        return 0;  
      }
      curl_close ($ch);
}


//kalau tidak ada report di dataset, maka kirim file untuk di scan (vt v2)
function scanVtUser($file, $hash){

    header("Content-Type: text/plain"); 
    $apikey = "e4f0c6fc1643f7fb301d1e19d3ab6720fcfd3a2e7a625d909e2082647920906b";

    //[BAGIAN 1] memeriksa apakah laporan untuk file ini sudah ada (menggunakan sha256)
    // atau dengan memberikan scan_id yang Anda terima saat memposting file baru untuk pemindaian
    // !!! Perhatikan bahwa scan_id adalah satu-satunya yang menunjukkan file sedang antri / tertunda, yang lain hanya akan melaporkan setelah pemindaian selesai !!!
    $report = 'https://www.virustotal.com/vtapi/v2/file/report?apikey='.$apikey."&resource=".$hash;

    // respon public api virus total
    $api_reply = file_get_contents($report);
    $api_reply_array = json_decode($api_reply, true);

    // jika file sedang diantrikan untuk analisis
    if($api_reply_array['response_code']==-2){
        $msg = $api_reply_array['verbose_msg'];
        header("Location: deteksi_vtmsg.php?msg=$msg");
        exit;
    }

    // jika report file ada (berisi laporan antivirus)
    if($api_reply_array['response_code']==1){
        $result = $api_reply_array;
        return $result;
    }

    // jika report mengenai file ini tidak ditemukan, upload file ini untuk d scan
    if($api_reply_array['response_code']=='0'){

      // upload file ke url scan 
      $post_url = 'https://www.virustotal.com/vtapi/v2/file/scan';

      // jika size file lebih dari 32MB (up to 200MB), kirim ke url upload 
      if($size >= 32){
        $api_reply = @file_get_contents('https://www.virustotal.com/vtapi/v2/file/scan/upload_url?apikey='.$apikey);
        $api_reply_array = json_decode($api_reply, true);
        if(isset($api_reply_array['upload_url']) and $api_reply_array['upload_url']!=''){
          $post_url = $api_reply_array['upload_url'];
        }
      }
      
      // kirim file untuk pengecekan
      // curl akan menerima array
      $post['apikey'] = $apikey;
      $post['file'] = '@'.$file;
      
      $ch = curl_init();
      curl_setopt($ch, CURLOPT_URL,$post_url);
      curl_setopt($ch, CURLOPT_POST,1);
      curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
      curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
      $api_reply = curl_exec ($ch);
      curl_close ($ch);
      
      $api_reply_array = json_decode($api_reply, true);
      
      if($api_reply_array['response_code']==1){
          $scanID = $api_reply_array['scan_id'];
          header("Location: deteksi_vtmsg.php?scanID=$scanID");
          exit;
      }

    }
}


//kalau tidak ada report di dataset, maka kirim file untuk di scan (vt v2)
function scanVtMitra($idm, $file, $hash){

  header("Content-Type: text/plain"); 
  $apikey = "e4f0c6fc1643f7fb301d1e19d3ab6720fcfd3a2e7a625d909e2082647920906b";

  //periksa apakah laporan untuk file ini sudah ada (menggunakan sha256)
  $report = 'https://www.virustotal.com/vtapi/v2/file/report?apikey='.$apikey."&resource=".$hash;

  // respon public api virus total
  $api_reply = file_get_contents($report);
  $api_reply_array = json_decode($api_reply, true);

  // jika file sedang diantrikan untuk analisis
  if($api_reply_array['response_code']==-2){
      $msg = $api_reply_array['verbose_msg'];
      header("Location: m.deteksi_vtmsg.php?idm=$idm &msg=$msg");
      exit;
  }

  // jika report file ada (berisi laporan antivirus)
  if($api_reply_array['response_code']==1){
      $result = $api_reply_array;
      return $result;
  }

  // jika report mengenai file ini tidak ditemukan, upload file ini untuk d scan
  if($api_reply_array['response_code']=='0'){

    // upload file ke url scan 
    $post_url = 'https://www.virustotal.com/vtapi/v2/file/scan';

    // kirim file untuk pengecekan
    $post['apikey'] = $apikey;
    $post['file'] = '@'.$file;
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL,$post_url);
    curl_setopt($ch, CURLOPT_POST,1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER,1);
    $api_reply = curl_exec ($ch);
    curl_close ($ch);
    
    $api_reply_array = json_decode($api_reply, true);
    
    if($api_reply_array['response_code']==1){
        $scanID = $api_reply_array['scan_id'];
        header("Location: m.deteksi_vtmsg.php?idm=$idm&scanID=$scanID");
        exit;
    }

  }
}

?>