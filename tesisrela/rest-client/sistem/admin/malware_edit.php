<?php 
session_start();
if( !isset($_SESSION["login"])){
  header("Location: login.php");
  exit;
}


//---------------------RESTFULL-------------------------
require '../function/functions.php';
require '../function/functions_malware.php';
require '../api/api_malware.php';
require '../api/api_recent.php';
require '../api/api_admin.php';

$ida = $_GET['ida'];
$admin = getAdminById($ida);

$id = $_GET["id"];
$mal = getMalwareById($id);

//cek apakah tombol submit sudah ditekan atau belum:
if (isset($_POST["submit"])) {

  //------------------kalo file edit-------------------
  //cek file diubah atau tidak
  if(cekFile() < 1){
    //file tidak diubah
    $result = updateMalware($_POST);   

  } else {
    //file diubah, cek size dan ekstensi
    if(cekSizeFile() < 1){
      exit;
    }
    $result = updateMalwareFile($_POST);
  }
  //-------------file edit---------------------

  //cek apakah data berhasil diubah atau tidak
  if( $result["status"] === 1 ){

      //input ke recent
      $dataRec = [
        'file' => $mal["file_malware"],
        'sha256' => $mal["sha256_malware"],
        'status' => "Malware",
        'aksi' => "Diedit",
        'oleh' => $admin["username"]
      ];

      if( createRecent($dataRec) === 0){
        echo "<script>
              alert('Data Gagal ditambahkan ke recent!');
              document.location.href = 'malware.php?ida=$ida';
              </script>";
      }

  //kalau berhasil
  echo "<script>
      alert('Data BERHASIL Diubah!');
      document.location.href = 'malware.php?ida=$ida';
      </script>";

  //kalau gagal
  } else {
    echo "<script>
          alert('Data GAGAL Diubah!');
          document.location.href = 'malware.php?ida=$ida';
          </script>";
  }
}
?>

<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../fontawesome-web/css/all.min.css">
    <title>Sistem Database Malware</title>
  </head>

  <body>
    <!-- jumbotron -->
    <div class="bg-dark py-3">
      <div class="container text-center">
        <img src="../../img/1.png" width="10%" class="rounded-circle">
        <h2 class="text-light">Sistem Database Malware</h2>
      </div>
    </div>
    <!-- akhir jumbotron -->

    <!-- navbar -->
    <div class="row">
      <div class="col-sm-2 bg-light">
        <nav class="navbar fixed-left navbar-expand-lg navbar-light bg-light py-4">          
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav flex-column">
                <a class="nav-item nav-link btn-white btn-lg" href="home.php?ida=<?=$ida;?>"><i class="fas fa-home pr-2"></i>Home</a>
                <a class="nav-item nav-link btn-white btn-lg" href="benign.php?ida=<?=$ida;?>"><i class="fas fa-file pr-2"></i>DB Benign</a>
                <a class="nav-item nav-link btn-info btn-lg text-white active" href="malware.php?ida=<?=$ida;?>"><i class="fas fa-database pr-2"></i>DB Malware<span class="sr-only">(current)</span></a>
                <a class="nav-item nav-link btn-white btn-lg" href="analisa.php?ida=<?=$ida;?>"><i class="fas fa-clipboard pr-2"></i>Analisa File</a>
                <a class="nav-item nav-link btn-white btn-lg" href="tambah_benign.php?ida=<?=$ida;?>"><i class="fas fa-plus pr-2"></i>Tambah File</a>
                <a class="nav-item nav-link btn-white btn-lg" href="recent.php?ida=<?=$ida;?>"><i class="fas fa-clock pr-2"></i>Recent</a>
                <a class="nav-item nav-link btn-white btn-lg" href="reg_admin.php?ida=<?=$ida;?>"><i class="fas fa-address-card pr-2"></i>Registrasi</a>
                <a class="nav-item nav-link btn-white btn-lg" href="admin.php?ida=<?=$ida;?>"><i class="fas fa-user pr-2"></i>Data Admin</a>
                <a class="nav-item nav-link btn-white btn-lg" href="mitra.php?ida=<?=$ida;?>"><i class="fas fa-address-book pr-2"></i>Data Mitra</a>
                <a class="nav-item nav-link btn-white btn-lg" data-toggle="modal" data-target="#logoutModal"><i class="fas fa-sign-out-alt pr-2"></i>Logout</a>
              </div>
            </div>
        </nav>
      </div>

      <!-- menu MALWARE -->
      <div class="col-sm-10">
        <h1 class="font-weight-bold pt-3">DATABASE MALWARE</h1>
        <p>Mengubah data file malware :</p>

        <!-- EDIT-ANALISA-->
        <section class="malware_edit" id="malware_edit">
          <div class="text-center pt-1">
            <h4 class="alert-info font-weight-bold py-2 mb-3">Edit File & Analisa Malware</h4>
          </div>

          <div class="container">  
          <form action="" method="post" enctype="multipart/form-data">
            <div class="form-row">
              <div class="form-group col-sm-3 pt-4">
                <h4 class="font-weight-bold text-danger pt-2"><img class="mx-2" src="../../img/4.png" width="10%">MALWARE !!!</h4>
                <img class="pt-3 ml-5" src="../../img/3.png" width="160">
              </div>

              <div class="form-group col-md-9 mt-3">
                <input type="hidden" name="id_malware" value="<?= $mal["id_malware"]; ?>">
                <input type="hidden" name="waktu" value="<?= $mal["waktu"]; ?>">
                <input type="hidden" name="file_malware" value="<?= $mal["file_malware"]; ?>">
                <input type="hidden" name="tipe_file_malware" value="<?= $mal["tipe_file_malware"]; ?>">
                <input type="hidden" name="ukuran_file_malware" value="<?= $mal["ukuran_file_malware"]; ?>">
                <input type="hidden" name="md5_malware" value="<?= $mal["md5_malware"]; ?>">
                <input type="hidden" name="sha1_malware" value="<?= $mal["sha1_malware"]; ?>">
                <input type="hidden" name="sha256_malware" value="<?= $mal["sha256_malware"]; ?>">
                <input type="hidden" name="ssdeep" value="<?= $mal["ssdeep"]; ?>">

                <h5 class="text-info mt-1">Data File Malware :</h5>
                <ul>
                  <li class="text-secondary">
                    <label>Waktu Input :</label>
                    <label><?= $mal["waktu"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>Nama File :</label>
                    <label><?= $mal["file_malware"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>Tipe File :</label>
                    <label><?= $mal["tipe_file_malware"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>Ukuran File :</label>
                    <label><?= $mal["ukuran_file_malware"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>MD5 :</label>
                    <label><?= $mal["md5_malware"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>SHA-1 :</label>
                    <label><?= $mal["sha1_malware"]; ?></label>
                  </li>
                  <li class="text-secondary">
                    <label>Signature (SHA-256) :</label>
                    <label><?= $mal["sha256_malware"]; ?></label>
                  </li>
                </ul>

                <!-- kalo edit file -->
                <hr>
                <div class="form-group row pl-3">
                  <label for="file_malware_baru" class="text-info pr-4"><h5>Pilih File Baru :</h5></label><br>
                  <input type="file" name="file_malware_baru" id="file_malware_baru">
                </div>
                <!-- edit file -->

            <div class="form-group row">
              <label for="ssdeep" class="col-sm-2 col-form-label">SSDEEP</label>
              <div class="col-sm-10">
                 <input type="text" name="ssdeep" id="ssdeep" required value="<?= $mal["ssdeep"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="vhash" class="col-sm-2 col-form-label">Vhash</label>
              <div class="col-sm-10">
                 <input type="text" name="vhash" id="vhash" required value="<?= $mal["vhash"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

              </div>
            </div>
      <!-- akhir EDIT-ANALISA -->

      <!-- EDIT-METADATA -->  
            <div class="text-center pt-1">
              <h4 class="alert-info font-weight-bold py-2 mb-4">Edit Metadata Malware</h4>
            </div>



            <div class="form-group row">
              <label for="nama" class="col-sm-2 col-form-label">Nama Malware</label>
              <div class="col-sm-10">
                 <input type="text" name="nama" id="nama" required value="<?= $mal["nama"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="nama_lain" class="col-sm-2 col-form-label">Nama Lain</label>
              <div class="col-sm-10">
                 <input type="text" name="nama_lain" id="nama_lain" value="<?= $mal["nama_lain"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="jenis" class="col-sm-2 col-form-label">Jenis Malware</label>
              <div class="col-sm-10">
                 <input type="text" name="jenis" id="jenis" value="<?= $mal["jenis"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="karakteristik" class="col-sm-2 col-form-label">Karakteristik Malware</label>
              <div class="col-sm-10">
                <input type="text" name="karakteristik" id="karakteristik" value="<?= $mal["karakteristik"]; ?>" class="form-control form-control-sm">
              </div>
            </div> 

            <div class="form-group row">
              <label for="cara_kerja" class="col-sm-2 col-form-label">Cara Kerja & Operasi</label>
              <div class="col-sm-10">
                <input type="text" name="cara_kerja" id="cara_kerja" value="<?= $mal["cara_kerja"]; ?>" class="form-control form-control-sm">
              </div>
            </div>   

            <div class="form-group row">
              <label for="penyebaran" class="col-sm-2 col-form-label">Penyebaran</label>
              <div class="col-sm-10">
                <input type="text" name="penyebaran" id="penyebaran" value="<?= $mal["penyebaran"]; ?>" class="form-control form-control-sm">
              </div>
            </div> 

            <div class="form-group row">
              <label for="bahaya" class="col-sm-2 col-form-label">Tingkat Bahaya</label>
              <div class="col-sm-10">
                <input type="text" name="bahaya" id="bahaya" value="<?= $mal["bahaya"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="target" class="col-sm-2 col-form-label">Target</label>
              <div class="col-sm-10">
                <input type="text" name="target" id="target" value="<?= $mal["target"]; ?>" class="form-control form-control-sm">
              </div>
            </div> 

            <div class="form-group row">
              <label for="ket" class="col-sm-2 col-form-label">Keterangan Lain</label>
              <div class="col-sm-10">
                <input type="text" name="ket" id="ket" value="<?= $mal["ket"]; ?>" class="form-control form-control-sm">
              </div>
            </div> 
        <!-- akhir EDIT-METADATA -->

        <!-- EDIT-PENANGANAN -->
            <div class="text-center pt-1">
              <h4 class="alert-info font-weight-bold py-2 mb-4">Edit Penanganan Malware</h4>
            </div>

            <div class="form-group row">
              <label for="pencegahan" class="col-sm-2 col-form-label">Pencegahan</label>
              <div class="col-sm-10">
                <input type="text" name="pencegahan" id="pencegahan" value="<?= $mal["pencegahan"]; ?>" class="form-control form-control-sm">
              </div>
            </div>
            
            <div class="form-group row">
              <label for="penanganan" class="col-sm-2 col-form-label">Penanganan</label>
              <div class="col-sm-10">
                <input type="text" name="penanganan" id="penanganan" value="<?= $mal["penanganan"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="pemulihan" class="col-sm-2 col-form-label">Pemulihan & Perbaikan</label>
              <div class="col-sm-10">
                <input type="text" name="pemulihan" id="pemulihan" value="<?= $mal["pemulihan"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

        <!-- akhir EDIT PENANGANAN -->

        <!-- EDIT DATA RANSOME -->
            <div class="text-center pt-1">
              <h4 class="alert-info font-weight-bold py-2 mb-4">Data Khusus Ransomware</h4>
            </div>

            <div class="form-group row">
              <label for="pembuat_file" class="col-sm-2 col-form-label">File Maker</label>
              <div class="col-sm-10">
                <input type="text" name="pembuat_file" id="pembuat_file" value="<?= $mal["pembuat_file"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="note" class="col-sm-2 col-form-label">Ransome Note</label>
              <div class="col-sm-10">
                <input type="text" name="note" id="note" value="<?= $mal["note"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="kontak" class="col-sm-2 col-form-label">Kontak Email Pelaku</label>
              <div class="col-sm-10">
                <input type="text" name="kontak" id="kontak" value="<?= $mal["kontak"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="enkripsi" class="col-sm-2 col-form-label">Metode Enkripsi</label>
              <div class="col-sm-10">
                <input type="text" name="enkripsi" id="enkripsi" value="<?= $mal["enkripsi"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="form-group row">
              <label for="tebusan" class="col-sm-2 col-form-label">Tebusan</label>
              <div class="col-sm-10">
                <input type="text" name="tebusan" id="tebusan" value="<?= $mal["tebusan"]; ?>" class="form-control form-control-sm">
              </div>
            </div>

            <div class="text-center py-2">
              <button type="submit" name="submit" class="btn btn-primary mb-3" onclick="return confirm('Apakah anda yakin akan mengubah data ini?')">Ubah</button>
              <a href="malware.php?ida=<?=$ida;?>" class="btn btn-secondary mb-3">Kembali</a>
            </div>
          </form>
          </div>           
        </section>
      </div>
        <!-- akhir EDIT-DATA RANSOME -->

      <!-- menu LOGOUT -->
      <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="logoutModalLabel">LOGOUT</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Apakah anda yakin akan keluar dari menu admin?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
              <a href="logout.php"><button type="button" class="btn btn-primary">Keluar</button></a>
            </div>
          </div>
        </div>
      </div>
      <!-- akhir menu LOGOUT -->   
    </div>
    <!-- akhir navbar -->
    
    <!-- footer -->
    <footer class="bg-dark text-white">
      <div class="row pt-3">
        <div class="col text-center">
          <p>&copy; Copyright 2020 | by Rela Annisa Camilia.</p>
        </div>
      </div>
    </footer>
    <!-- akhir footer -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="../../js/jquery-3.4.1.min.js"></script>
    <script src="../../js/popper.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
  </body>
</html>