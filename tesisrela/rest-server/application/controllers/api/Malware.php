<?php
use Restserver\Libraries\REST_Controller;
defined('BASEPATH') or exit ('No direct script access allowed');

require APPPATH . 'libraries/REST_Controller.php';
require APPPATH . 'libraries/Format.php';


class Malware extends REST_Controller
{
    public function __construct()
    {
        parent::__construct();
        $this->load->model('Malware_model', 'malware');
    }


   //--------------------------------GET-----------------------------
    public function index_get()
    {   

        $id = $this->get('id_malware');
        $sha256 = $this->get('sha256');

        //get all
        if (($id && $sha256) === null) {
            $malware = $this->malware->getMalware();
        //get by id
        } else if ($sha256 === null){
            $malware = $this->malware->getMalware($id);
        //get by hash
        } else if ($id === null){
            $malware = $this->malware->getMalwareByHash($sha256);
        }

        if($malware)
        {
            $this->response([
                'status' => 1,
                'data' => $malware
            ], REST_Controller::HTTP_OK); 
        } else {
            $this->response([
                'status' => 0,
                'data' => 'tidak ada hash yang sama'
            ]); 
        }
    }


   //-------------------------------HAPUS-----------------------------
    public function index_delete()
    {
        $id = $this->delete('id_malware');
        if ($id === null){
            //tidak memasukkan id
            $this->response([
                'status' => o,
                'message' => 'masukkan id malware yang ingin dihapus'
            ]);
        } else {

            if( $this->malware->deleteMalware($id) > 0){
                //ok
                $this->response([
                    'status' => 1,
                    'id' => $id,
                    'message' => 'terhapus'
                ], REST_Controller::HTTP_OK); 
            } else {
                //id not found
                $this->response([
                    'status' => 0,
                    'message' => 'id malware tidak ditemukan'
                ]);
            }
        }
    }

    
    //--------------------------------TAMBAH------------------------------
    public function index_post()
    {     
        $sha256 = $this->post('sha256_malware');
        $fileName = $this->post('file_malware');
        $contents = $this->post('contents');
        
        //cek dulu apa file malware sudah ada didatabase?  
        $malware = $this->malware->getMalwareByHash($sha256);
     
        if($malware){
            //kalo sudah ada
            $this->response([
                'status' => 2,
                'message' => 'Sampel yang sama sudah tersimpan dalam Database Malware!'
            ]);

        } else {            
            //kalo blm ada maka (1) upload file dlm zip:
            $file_malware = $this->malware->uploadMalware($contents, $fileName);

            // (2) siapkan data yang di input ke db
            $data = [

                'waktu' => $this->post('waktu'),
                'file_malware' => $file_malware,
                'tipe_file_malware' => $this->post('tipe_file_malware'),
                'ukuran_file_malware' => $this->post('ukuran_file_malware'),
                'md5_malware' => $this->post('md5_malware'),
                'sha1_malware' => $this->post('sha1_malware'),
                'sha256_malware' => $this->post('sha256_malware'),
                'ssdeep' => $this->post('ssdeep'),
                'vhash' => $this->post('vhash'),
                'nama' => $this->post('nama'),
                'nama_lain' => $this->post('nama_lain'),
                'jenis' => $this->post('jenis'),
                'karakteristik' => $this->post('karakteristik'),
                'cara_kerja' => $this->post('cara_kerja'),
                'penyebaran' => $this->post('penyebaran'),
                'bahaya' => $this->post('bahaya'),
                'target' => $this->post('target'),
                'ket' => $this->post('ket'),
                'pencegahan' => $this->post('pencegahan'),
                'penanganan' => $this->post('penanganan'),
                'pemulihan' => $this->post('pemulihan'),
                'pembuat_file' => $this->post('pembuat_file'),
                'note' => $this->post('note'),
                'kontak' => $this->post('kontak'),
                'enkripsi' => $this->post('enkripsi'),
                'tebusan' => $this->post('tebusan')
    
            ];

            
            // (3) lalu tambahkan data ke db malware
            if( $this->malware->createMalware($data) > 0){
                $this->response([
                    'status' => 1,
                    'message' => 'file baru berhasil ditambahkan'
                ], REST_Controller::HTTP_CREATED); 

            } else {
                $this->response([
                    'status' => 0,
                    'message' => 'gagal menambahkan data'
                ]);
            }
        }
    }


    //----------------------------------EDIT------------------------------
    public function index_put()
    {
        $id = $this->put('id_malware');
        $contents = $this->put('contents');
        $fileName = $this->put('file_malware');

        //kalau ada contents -> upload file dulu 
        if($contents !== null){
            $fileName = $this->malware->uploadMalware($contents, $fileName);

            if($fileName === 0){
                $this->response([
                    'status' => 2,
                    'message' => 'Gagal mengupload foto!'
                ]);
            } 
        } 

        
        $data = [
            'waktu' => $this->put('waktu'),
            'file_malware' => $this->put('file_malware'),
            'tipe_file_malware' => $this->put('tipe_file_malware'),
            'ukuran_file_malware' => $this->put('ukuran_file_malware'),
            'md5_malware' => $this->put('md5_malware'),
            'sha1_malware' => $this->put('sha1_malware'),
            'sha256_malware' => $this->put('sha256_malware'),
            'ssdeep' => $this->put('ssdeep'),
            'vhash' => $this->put('vhash'),
            'nama' => $this->put('nama'),
            'nama_lain' => $this->put('nama_lain'),
            'jenis' => $this->put('jenis'),
            'karakteristik' => $this->put('karakteristik'),
            'cara_kerja' => $this->put('cara_kerja'),
            'penyebaran' => $this->put('penyebaran'),
            'bahaya' => $this->put('bahaya'),
            'target' => $this->put('target'),
            'ket' => $this->put('ket'),
            'pencegahan' => $this->put('pencegahan'),
            'penanganan' => $this->put('penanganan'),
            'pemulihan' => $this->put('pemulihan'),
            'pembuat_file' => $this->put('pembuat_file'),
            'note' => $this->put('note'),
            'kontak' => $this->put('kontak'),
            'enkripsi' => $this->put('enkripsi'),
            'tebusan' => $this->put('tebusan'),
        ];

        if( $this->malware->updateMalware($data, $id) > 0){
            $this->response([
                'status' => 1,
                'message' => 'Data berhasil diubah!'
            ], REST_Controller::HTTP_OK); 
        } else {
            $this->response([
                'status' => 0,
                'message' => 'Gagal mengubah data!'
            ]);
        }
    }
}

?>